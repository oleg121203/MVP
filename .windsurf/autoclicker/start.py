#!/usr/bin/env python3

import sys
import subprocess
import importlib.util

# –°–ª–æ–≤–Ω–∏–∫, –¥–µ –∫–ª—é—á - –Ω–∞–∑–≤–∞ –ø–∞–∫–µ—Ç–∞ –¥–ª—è pip, –∞ –∑–Ω–∞—á–µ–Ω–Ω—è - –Ω–∞–∑–≤–∞ –º–æ–¥—É–ª—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
REQUIRED_PACKAGES = {
    'Pillow': 'PIL',
    'opencv-python': 'cv2',
    'PyAutoGUI': 'pyautogui'
}

def check_and_install_packages():
    """
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–∞–∫–µ—Ç–∏. –Ø–∫—â–æ –Ω—ñ - –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î —ó—Ö.
    """
    print("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫...")
    all_packages_installed = True
    
    for package_name, module_name in REQUIRED_PACKAGES.items():
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—é –º–æ–¥—É–ª—è. –Ø–∫—â–æ –Ω—ñ - –≤—ñ–Ω –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π.
        spec = importlib.util.find_spec(module_name)
        if spec is None:
            all_packages_installed = False
            print(f"üü° –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ '{package_name}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞. –°–ø—Ä–æ–±–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏...")
            try:
                # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ–π —Å–∞–º–∏–π —ñ–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Python –¥–ª—è –≤–∏–∫–ª–∏–∫—É pip
                subprocess.check_call([sys.executable, "-m", "pip", "install", package_name])
                print(f"‚úÖ –ë—ñ–±–ª—ñ–æ—Ç–µ–∫—É '{package_name}' —É—Å–ø—ñ—à–Ω–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
            except subprocess.CalledProcessError:
                print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è '{package_name}'.")
                print("–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —ó—ó –≤—Ä—É—á–Ω—É, –≤–∏–∫–æ–Ω–∞–≤—à–∏ –∫–æ–º–∞–Ω–¥—É:")
                print(f"   pip install {package_name}")
                return False
    
    if all_packages_installed:
        print("‚úÖ –£—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.")
        
    return True

def run_main_script():
    """
    –ó–∞–ø—É—Å–∫–∞—î –æ—Å–Ω–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó.
    """
    import os
    # –û—Ç—Ä–∏–º—É—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é, –¥–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∏–π —Å–∫—Ä–∏–ø—Ç
    script_dir = os.path.dirname(os.path.abspath(__file__))
    script_path = os.path.join(script_dir, "autoclicker.py")
    print(f"\nüöÄ –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞: {script_path}")
    try:
        # –ó–∞–ø—É—Å–∫–∞—î–º–æ autoclicker.py —è–∫ –¥–æ—á—ñ—Ä–Ω—ñ–π –ø—Ä–æ—Ü–µ—Å
        subprocess.run([sys.executable, script_path], check=True)
    except FileNotFoundError:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞: –û—Å–Ω–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç '{script_path}' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
        print("–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ 'start.py' —Ç–∞ 'autoclicker.py' –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ –æ–¥–Ω—ñ–π –ø–∞–ø—Ü—ñ.")
    except subprocess.CalledProcessError as e:
        # –¶—è –ø–æ–º–∏–ª–∫–∞ –º–æ–∂–µ –≤–∏–Ω–∏–∫–Ω—É—Ç–∏, —è–∫—â–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –Ω–µ–Ω—É–ª—å–æ–≤–∏–º –∫–æ–¥–æ–º,
        # –∞–ª–µ —Ü–µ –Ω–µ –∑–∞–≤–∂–¥–∏ –æ–∑–Ω–∞—á–∞—î –ø—Ä–æ–±–ª–µ–º—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∑—É–ø–∏–Ω–∫–∞ —á–µ—Ä–µ–∑ Ctrl+C).
        print(f"\n‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç 'autoclicker.py' –∑–∞–≤–µ—Ä—à–∏–≤ —Ä–æ–±–æ—Ç—É –∑ –∫–æ–¥–æ–º –≤–∏—Ö–æ–¥—É {e.returncode}.")

if __name__ == "__main__":
    if check_and_install_packages():
        run_main_script()
    else:
        print("\nüõë –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –¥–ª—è –∑–∞–ø—É—Å–∫—É. –í–∏–ø—Ä–∞–≤—Ç–µ –ø–æ–º–∏–ª–∫–∏ –≤–∏—â–µ —Ç–∞ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É.")
        # –ó–∞—Ç—Ä–∏–º–∫–∞, —â–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤—Å—Ç–∏–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
        input("–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter –¥–ª—è –≤–∏—Ö–æ–¥—É...")